# 交通費精算システム拡張スクリプト (Pleasanter + GAS)

プリザンターの「交通費精算」アプリに対し、UI/UXの改善、OCR読み取り、PDF帳票出力機能を追加するスクリプト群です。
Google Apps Script (GAS) と連携して動作します。

## 📌 機能一覧

### プリザンター側 (Front-end)
* **入力補助UI:**
    * 過去の履歴からの引用登録
    * お気に入り経路の登録・引用
    * レシート画像からのOCR読み取り (Gemini API連携)
* **操作性向上:**
    * 子レコード（明細行）のドラッグ＆ドロップによる並び替え
    * ステータスに応じた入力項目のロック制御（申請者以外は編集不可など）
    * 標準の時計/人アイコン等の非表示制御（Shadow DOM対応）
* **帳票出力:**
    * 「PDF出力」ボタンによる精算書のPDF化

### GAS側 (Back-end)
* **OCR処理:** アップロードされた画像を Gemini 1.5 Flash に投げてJSON化
* **交通情報検索処理:** 出発駅・到着駅情報を駅すぱあとAPIに投げて検索結果のページを表示
* **PDF生成:** スプレッドシートをテンプレートとして利用し、データを差し込んでPDF化して返却

## 🚀 運用方法
各ファイルは(テーブル名)_(スクリプト対象画面).jsという命名規則になっている。  
例) 交通費精算_編集画面.js ・・・「交通費精算」テーブルの「編集画面」で動作させるスクリプト
##導入方法
初めてプリザンターを導入した時の作業。  
既に本スクリプトを運用中であれば、「導入方法」の下にある「更新方法」を参照
### 事前準備
1. 本スクリプトをダウンロードする(任意のフォルダで可)。
2. **プリザンター側でテーブルを作成。**
*「サイドパッケージのインポート」からサイドパッケージをインポートする※サイドパッケージがまだなければ、大変だが各テーブル構成を同じようにして作る必要がある。
3. **スクリプト内定数の書き換え:**
   コード上部の `【設定エリア】` にある定数を環境に合わせて変更してください。  
   **更新必要な項目**  
   * 各テーブルID
    ```javascript
    const GAS_TRANSREPO_URL = '[https://script.google.com/](https://script.google.com/)...'; // 手順1で発行したURL
    const CHILD_TABLE_ID = 123456; // 明細テーブルのID
    // その他、各種テーブルIDや項目ID
    ```
### 導入手順
1. 対象のテーブルの「管理」>「スクリプト」を開きます。
2. 「新規作成」を選択し、任意のタイトルを入力(分かりやすさからスクリプト対象画面の名前で命名することを推奨)し、スクリプト欄に.jsファイルの中身をコピー&ペースト。
3. 出力先の「全て」のチェックを外し、対象画面のチェックを付ける。
4. 画面下の「更新」を選択、その後再度画面下の「更新」を選択(スクリプト更新後にテーブル管理の更新が必要なため。)

### 更新方法
既に本スクリプトを運用中であれば以下を実施
1. 対象のテーブルの「管理」>「スクリプト」を開きます。
2. 対象のスクリプトを選択し、スクリプトの内容を新規の内容に上書きする。
4. 画面下の「更新」を選択、その後再度画面下の「更新」を選択(スクリプト更新後にテーブル管理の更新が必要なため。)
