# 交通費精算システム拡張スクリプト (Pleasanter + GAS)

プリザンターの「交通費精算」アプリに対し、UI/UXの改善、OCR読み取り、PDF帳票出力機能を追加するスクリプト群です。
Google Apps Script (GAS) と連携して動作します。

## 📌 機能一覧

### プリザンター側 (Front-end)
* **入力補助UI:**
    * 過去の履歴からの引用登録
    * お気に入り経路の登録・引用
    * レシート画像からのOCR読み取り (Gemini API連携)
* **操作性向上:**
    * 子レコード（明細行）のドラッグ＆ドロップによる並び替え
    * ステータスに応じた入力項目のロック制御（申請者以外は編集不可など）
    * 標準の時計/人アイコン等の非表示制御（Shadow DOM対応）
* **帳票出力:**
    * 「PDF出力」ボタンによる精算書のPDF化

### GAS側 (Back-end)
* **OCR処理:** アップロードされた画像を Gemini 1.5 Flash に投げてJSON化
* **PDF生成:** スプレッドシートをテンプレートとして利用し、データを差し込んでPDF化して返却

## 🛠 前提条件

* **Pleasanter:** サーバーサイドスクリプトおよびサイトパッケージのインポート権限
* **Google Cloud:** Gemini API Key の取得
* **Google Drive:** GASおよびテンプレート用スプレッドシートの配置

## 🚀 セットアップ手順

### 1. Google Apps Script (GAS) の準備
1. Googleドライブ上で新規GASプロジェクトを作成し、`code.gs` に本リポジトリの `GAS/code.gs` の内容を転記してください。
2. **スクリプトプロパティ（定数）の設定:**
    * `GEMINI_API_KEY`: 取得したGeminiのAPIキー
    * `TRANSREPO_URL`: テンプレートとなるスプレッドシートのURL
3. **権限の承認:**
    * 初回実行時、または `UrlFetchApp` (外部通信) や `SpreadsheetApp` (シート操作) の権限承認を行ってください。
4. **デプロイ:**
    * 「デプロイ」>「新しいデプロイ」から「ウェブアプリ」として公開してください。
    * **重要:** `Who has access` (アクセスできるユーザー) は運用に合わせて設定してください（通常は `Anyone` 等）。
    * 発行された **Web App URL** を控えてください。

### 2. プリザンター側の設定
1. 対象の「期限付きテーブル（親）」の「管理」>「スクリプト」を開きます。
2. 新規作成し、本リポジトリの `Pleasanter/parent_script.js` の内容を貼り付けます。
3. **定数の書き換え:**
    * コード上部の `【設定エリア】` にある定数を環境に合わせて変更してください。
    ```javascript
    const GAS_TRANSREPO_URL = '[https://script.google.com/](https://script.google.com/)...'; // 手順1で発行したURL
    const CHILD_TABLE_ID = 123456; // 明細テーブルのID
    // その他、各種テーブルIDや項目ID
    ```
4. 出力を「編集」画面に設定して保存します。

## ⚠️ 運用・開発時の注意点

### GASのデプロイ更新について
GAS側のコードを変更した場合、**必ず「デプロイの管理」から「バージョン：新バージョン」を選択してデプロイし直してください。**
単にコードを保存しただけでは、WebアプリのURLに反映されず、古いコードが動き続けます（よくあるトラブルです）。

### 子レコードのロック制御について
ステータスが「完了」などの場合、子レコードの編集を防ぐために特殊な制御を行っています。
* `date-field` などのカスタムタグを削除（Unwrap）して `input` タグのみにすることで、時計アイコン等を強制的に非表示にしています。
* HTML構造が変わるため、値を参照する際は `.text()` ではなく `.val()` を使用してください。

### 認証エラーが出る場合
PDF出力時に `Exception: ...` というエラーが出る場合は、GAS側の権限不足です。
GASエディタ上で一度ダミー関数を実行して権限ポップアップを承認し、その後**デプロイを新バージョンで更新**してください。

## 📂 ファイル構成

* `Pleasanter/`
    * `parent_script.js`: 親テーブル用スクリプト（メイン）
* `GAS/`
    * `code.gs`: Google Apps Script用コード
